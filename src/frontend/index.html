<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>TODO</title>
    <link rel="stylesheet" href="style/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script>
    <script src="__d3-radviz.js"></script>
    <!-- <script type="text/javascript" src="script/configViz.js"></script> -->
    <script type="text/javascript" src="script/dataManage.js"></script>
    <script type="text/javascript" src="script/renderDeviations.js"></script>
    <script type="text/javascript" src="script/renderFitness.js"></script>
    <script type="text/javascript" src="script/renderIncidents.js"></script>
    <script type="text/javascript" src="script/renderPattern.js"></script>
</head>

<body>

  <div id="container_top">
    <div id="focus">FOCUS</div>
    <div id="context">CONTEXT</div>
  </div>

  <div id="container_middle">

    <div id="deviation"> 
      
      <div id="legend"></div>
      
      <div id="containerDev">
        <div id="divMissing">
          <div id="barMissing"></div>
        </div>

        <div id="divRepetition">
          <div id="barRepetition"></div>
        </div>

        <div id="divMismatch">
          <div id="barMismatch"></div>
        </div>
      </div>

      <div id="containerTop">
        <div id="divTopOne"></div>
        <div id="divTopTwo"></div>
        <div id="divTopThree"></div>
      </div>

      <div id="containerState">
        <div id="stateDeviations"></div>
      </div>

    </div>


    <div id="fitness">
      <div id="fitnessViolin"></div>
      <div id="fitnessBar"></div>

      <div id="costViolin"></div>
      <div id="costBar"></div>
      <!-- <div id="severityBar">SEVERITY</div> -->
    </div>
    
    <div id="incident">
      <div id="parallelIncidents"></div>
      <div id="barIncidents"></div>
    </div>
  </div>

  <div id="container_bottom">
    <div id="detail">DETAILS</div>

    <div id="pattern">
      <div id="patternChart"></div>
    </div>
  </div>
    
    <script>

      /* Filters */
      var selectedErrors = {missing: true, repetition:true, mismatch:true};
      var selectedActivities = {n:true, a:true, w:true, r:true, c:true};
      var fitnessRange = [0,1];
      var costRange = [0,1];

      async function loadData(){
        return await eel.alignmentsToJson()();
      }
      loadData().then(alignments => {

        const alignmentData = Object.entries(JSON.parse(alignments)).map(entry => {
          return {incident_id: entry[0],
            ...entry[1]
          };
        });
        var selectedData = alignmentData;

        // Render legend
        renderLegendError("legend");
        renderDeviationsBlock(alignmentData, selectedData)
        renderFitnessBlock(selectedData)
        // renderIncidents()
        // renderPattern()

          d3.selectAll(".barErr").on("click", function(d,i) {
            switch(i){
              case "Missing":
                selectedErrors.missing = !selectedErrors.missing;
                d3.select(this).style("opacity", selectedErrors.missing ? "1" : "0.5");
                break;
              case "Repetition":
                selectedErrors.repetition = !selectedErrors.repetition;
                d3.select(this).style("opacity", selectedErrors.repetition ? "1" : "0.5");
                break;
              case "Mismatch":
                selectedErrors.mismatch = !selectedErrors.mismatch
                d3.select(this).style("opacity", selectedErrors.mismatch ? "1" : "0.5");
                break;
              default:
                selectedErrors;
                break;
            }
            selectedData = filterError(alignmentData, selectedErrors);
            renderDeviationsBlock(alignmentData, selectedData);
            renderFitnessBlock(selectedData)
          });

          d3.selectAll(".barAct").on("click", function(d,i) {
            switch(i){
              case "Detection":
                selectedActivities.n = !selectedActivities.n
                d3.select(this).style("opacity", selectedActivities.n ? "1" : "0.5");
                break;
              case "Activation":
                selectedActivities.a = !selectedActivities.a
                d3.select(this).style("opacity", selectedActivities.a ? "1" : "0.5");
                break;
              case "Awaiting":
                selectedActivities.w = !selectedActivities.w
                d3.select(this).style("opacity", selectedActivities.w ? "1" : "0.5");
                break;
              case "Resolution":
                selectedActivities.r = !selectedActivities.r
                d3.select(this).style("opacity", selectedActivities.r ? "1" : "0.5");
                break;
              case "Closure":
                selectedActivities.c = !selectedActivities.c
                d3.select(this).style("opacity", selectedActivities.c ? "1" : "0.5");
                break;
              default:
                selectedActivities;
                break;
            }
            //TODO: da rifare meglio assolutamente
            selectedData = filterActivities(alignmentData, selectedActivities);
          });

          
        });



    </script>

</body>

</html>