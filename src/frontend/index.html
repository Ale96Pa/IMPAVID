<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Visual Analytics for Incident Management</title>
    <link rel="stylesheet" href="style/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script>
    <script src="__d3-radviz.js"></script>

    <script>
      /* Configurations */
      const colorDev = { tot:"grey", miss: "#bebada", rep: "#fdb462", mism: "#8dd3c7",
                        N:"#80b1d3", A:"#b3de69", W:"#fb8072",R:"#fccde5",C:"#ffffb3"};
      const dateRange = d3.timeDays(new Date(2016, 1, 19), new Date(2017, 2, 19));
      const formatTime = d3.timeFormat("%Y-%m-%d");
      const colorSeverity = {none:"#1a9641",low:"#a6d96a",medium:"#ffffbf",high:"#fdae61",critical:"#d7191c"};
      const threshold = {"low":0.37,"medium":0.69,"high":0.89}

      /* Shared data */
      var selectedCategories = [];

    </script>

    <script type="text/javascript" src="script/dataManage.js"></script>

    <script type="text/javascript" src="script/renderMetrics.js"></script>
    <script type="text/javascript" src="script/renderOverview.js"></script>
    <script type="text/javascript" src="script/renderHeader.js"></script>

    <script type="text/javascript" src="script/renderDeviations.js"></script>
    <script type="text/javascript" src="script/renderFitness.js"></script>
    <script type="text/javascript" src="script/renderIncidents.js"></script>

    <script type="text/javascript" src="script/renderPattern.js"></script>
</head>

<body>

  <div id="container_header">
    <div id="metrics"></div>
    <div id="legend"></div>
    <div id="actions">ACTIONS / ISO REFERENCE MODEL</div>
  </div>

  <div id="container_top">
    <div id="focus"></div>
    <div id="context"></div>
  </div>

  <div id="container_middle">

    <div id="deviation"> 
      
      <!-- <div id="legend"></div> -->
      
      <div id="containerDev">
        <div id="divMissing">
          <div id="barMissing"></div>
        </div>

        <div id="divRepetition">
          <div id="barRepetition"></div>
        </div>

        <div id="divMismatch">
          <div id="barMismatch"></div>
        </div>
      </div>

      <div id="containerTop">
        <p style="text-align: center; margin: 0;"><b>INCIDENTS WITH MOST ERRORS</b></p>
        <div id="divTopOne"></div>
        <div id="divTopTwo"></div>
        <div id="divTopThree"></div>
      </div>

      <div id="containerState">
        <div id="stateDeviations"></div>
      </div>

    </div>


    <div id="fitness">
      <div id="fitnessViolin"></div>
      <div id="fitnessBar"></div>

      <div id="costViolin"></div>
      <div id="costBar"></div>
      <!-- <div id="severityBar">SEVERITY</div> -->
    </div>
    
    <div id="incident">
      <div id="parallelIncidents"></div>
      <div id="barIncidents"></div>
    </div>
  </div>

  <div id="container_bottom">
    <div id="detail">DETAILS</div>

    <div id="pattern">
      <div id="patternChart"></div>
    </div>
  </div>
    
    <script>

      /* Filters */
      var alignmentData, incidentData, selectedAlignments, selectedIncidents;
      var selectedErrors = {missing: false, repetition:false, mismatch:false};
      var selectedActivities = {n:false, a:false, w:false, r:false, c:false};
      var fitnessRange = [0,1];
      var costRange = [0,1];
      // var selectedCategories = [];

      async function loadData(){
        const incidents = await eel.incidentsToJson()();
        incidentData = JSON.parse(incidents);
        return await eel.alignmentsToJson()();
      }
      loadData().then(alignments => {

        const alignmentData = Object.entries(JSON.parse(alignments)).map(entry => {
          return {incident_id: entry[0],
            ...entry[1]
          };
        });
        selectedAlignments = alignmentData;
        selectedIncidents = incidentData;

        renderMetrics(selectedAlignments);

        renderOverviewBlock(selectedAlignments, alignmentData, selectedIncidents, incidentData); //todo: selectedAlignments

        // Render legend
        renderLegendError("legend");

        // Render middle part
        renderDeviationsBlock(alignmentData, selectedAlignments)
        renderFitnessBlock(alignmentData, incidentData, selectedAlignments)
        renderIncidentsBlock(alignmentData, incidentData, selectedIncidents)

        // renderPattern()
                
        d3.selectAll(".barErr").on("click", function(d,i) {
          switch(i){
            case "Missing":
              selectedErrors.missing = !selectedErrors.missing;
              d3.select(this).style("opacity", selectedErrors.missing ? "1" : "0.5");
              break;
            case "Repetition":
              selectedErrors.repetition = !selectedErrors.repetition;
              d3.select(this).style("opacity", selectedErrors.repetition ? "1" : "0.5");
              break;
            case "Mismatch":
              selectedErrors.mismatch = !selectedErrors.mismatch
              d3.select(this).style("opacity", selectedErrors.mismatch ? "1" : "0.5");
              break;
            default:
              selectedErrors;
              break;
          }
          selectedAlignments = filterError(alignmentData, selectedErrors);

          renderOverviewBlock(selectedAlignments, alignmentData, selectedIncidents, incidentData);

          renderDeviationsBlock(alignmentData, selectedAlignments);
          renderFitnessBlock(alignmentData, incidentData, selectedAlignments);

          selectedIncidents = filterIncidentsByAlignments(selectedAlignments, incidentData);
          renderIncidentsBlock(alignmentData, incidentData, selectedIncidents);

          renderMetrics(selectedAlignments);
        });

        d3.selectAll(".barAct").on("click", function(d,i) {
          switch(i){
            case "Detection":
              selectedActivities.n = !selectedActivities.n
              d3.select(this).style("opacity", selectedActivities.n ? "1" : "0.5");
              break;
            case "Activation":
              selectedActivities.a = !selectedActivities.a
              d3.select(this).style("opacity", selectedActivities.a ? "1" : "0.5");
              break;
            case "Awaiting":
              selectedActivities.w = !selectedActivities.w
              d3.select(this).style("opacity", selectedActivities.w ? "1" : "0.5");
              break;
            case "Resolution":
              selectedActivities.r = !selectedActivities.r
              d3.select(this).style("opacity", selectedActivities.r ? "1" : "0.5");
              break;
            case "Closure":
              selectedActivities.c = !selectedActivities.c
              d3.select(this).style("opacity", selectedActivities.c ? "1" : "0.5");
              break;
            default:
              selectedActivities;
              break;
          }
          //TODO: da rifare meglio assolutamente
          selectedAlignments = filterActivities(alignmentData, selectedActivities);

          renderOverviewBlock(selectedAlignments, alignmentData, selectedIncidents, incidentData);

          selectedIncidents = filterIncidentsByAlignments(selectedAlignments, incidentData);
          renderIncidentsBlock(alignmentData, incidentData, selectedIncidents);

          renderMetrics(selectedAlignments);
        });    
      });



    </script>

</body>

</html>